<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html>
<head>
	<meta http-equiv="content-type" content="text/html; charset=utf-8"/>
	<title></title>
	<meta name="generator" content="LibreOffice 6.1.5.2 (Linux)"/>
	<meta name="created" content="2015-12-12T13:33:41.059217339"/>
	<meta name="changedby" content="Mark Grant"/>
	<meta name="changed" content="2019-09-15T09:09:13.204510228"/>
	<meta name="created" content="00:00:00">
	<meta name="created" content="00:00:00">
	<meta name="created" content="00:00:00">
	<meta name="created" content="00:00:00">
	<meta name="created" content="00:00:00">
	<meta name="created" content="00:00:00">
	<meta name="created" content="00:00:00">
	<meta name="created" content="00:00:00">
	<meta name="created" content="00:00:00">
	<meta name="created" content="00:00:00">
	<meta name="created" content="00:00:00">
	<meta name="created" content="00:00:00">
	<meta name="created" content="00:00:00">
	<meta name="created" content="00:00:00">
	<meta name="created" content="00:00:00">
	<meta name="created" content="00:00:00">
	<meta name="created" content="00:00:00">
	<meta name="created" content="00:00:00">
	<style type="text/css">
		@page { size: 21cm 29.7cm; margin: 2cm }
		p { margin-bottom: 0.25cm; background: transparent; line-height: 120%; background: transparent }
		h1 { margin-bottom: 0.21cm; background: transparent; background: transparent; page-break-after: avoid }
		h1.western { font-family: "Liberation Sans", sans-serif; font-size: 18pt; font-weight: bold }
		h1.cjk { font-family: "Droid Sans Fallback"; font-size: 18pt; font-weight: bold }
		h1.ctl { font-family: "FreeSans"; font-size: 18pt; font-weight: bold }
		a:link { color: #000080; so-language: zxx; text-decoration: underline }
		a:visited { color: #800000; so-language: zxx; text-decoration: underline }
	</style>
</head>
<body lang="en-GB" link="#000080" vlink="#800000" dir="ltr"><h1 class="western" align="center">
pbuilder Environment Setup Guide</h1>
<p align="left"><br/>
<br/>

</p>
<ol>
	<li><p align="left">Set-up .pbuilderrc. (See an example <a href="http://hermes/pkghost/debpkg/pbuilderrc">here</a>.):-</p>
	<ol type="a">
		<li><p align="left">pbuilder always needs root privileges so it
		will look for .pbuilderrc in /root. This is inconvenient, so you
		could set up a symlink in /root to point at a .pbuilderrc somewhere
		in your home directory.</p>
		<li><p align="left">PPA's can be added later in the chroot
		environment itself. In this file add other repositories to the
		OTHERMIRROR variable.</p>
		<ul>
			<li><p align="left">OTHERMIRROR=&quot;deb
			http://hermes/aptrepos/$OS $DIST stable&quot;</p>
		</ul>
		<li><p align="left">Add any additional APT keyrings.</p>
		<li><p align="left">Add distribution dependent elements.</p>
		<ul>
			<li><p align="left">Mirrors.</p>
			<li><p align="left">Components</p>
			<li><p align="left">DEBOOTSTRAPOPTS such as additional keyrings.</p>
		</ul>
		<li><p align="left">Add additional packages to be automatically
		included in the base tarball.</p>
		<ul>
			<li><p align="left">software-properties-common for adding PPAs.</p>
			<li><p align="left">wget, gnupg2 and dirmngr for key handling.</p>
		</ul>
		<li><p align="left">If supporting cross-builds then set any
		emulators needed in DEBOOTSTRAP.</p>
		<li><p align="left">Aptitude is the default dependency resolver for
		pbuilder but it does not work when cross-building for arm, so use
		apt:-</p>
		<ul>
			<li><p align="left">PBUILDERSATISFYDEPENDSCMD=/usr/lib/pbuilder/pbuilder-satisfydepends-apt</p>
			<li><p align="left">(This also needs the qemu-user-static package
			installed).</p>
		</ul>
		<li><p align="left">Set up various directories to use, such as:-</p>
		<ul>
			<li><p align="left">/var/cache/pbuilder/aptcache/debian-stretch-amd64</p>
		</ul>
		<li><p align="left">Save the file.</p>
	</ol>
	<li><p align="left">If the pbuilderrc file specifies an apt keyring
	for a local repository eg
	APTKEYRINGS=(&quot;/var/cache/pbuilder/keyrings/hermes.gpg&quot;)
	then that file needs to be put in place. This also has to happen if
	the repo key is updated, maybe because it has expired.</p>
	<ol type="a">
		<li><p align="left">For the above example statement, as root type</p>
	</ol>
</ol>
<ol>
	<ol type="a">
		<ul>
			<li><p align="left">wget -O -
			<a href="http://hermes/aptrepos/raspbian/conf/hermes.gpg">http://hermes/aptrepos/raspbian/conf/hermes.gpg</a>
			&gt; /<i>var/</i><span style="font-style: normal">cache/pbuilder/keyrings</span></p>
		</ul>
	</ol>
</ol>
<ol start="3">
	<li><p align="left">Create any hook files you want. e.g.:-</p>
	<ol type="a">
		<li><p align="left">A <a href="http://hermes/pkghost/debpkg/D40-gpgv-check-dsc">script</a>
		to run gpgv against all .dsc files prior to build.</p>
		<li><p align="left">A <a href="http://hermes/pkghost/debpkg/D60-apt-get-update">script</a>
		to run apt-get update before every build.</p>
		<li><p align="left">A <a href="http://hermes/pkghost/debpkg/E50-trustedkeys-kbx">script</a>
		to install your own gpg key when creating or updating a base
		tarball.</p>
		<li><p align="left">A <a href="http://hermes/pkghost/debpkg/H50-gpgv-warning">script</a>
		to print a warning that the standard gpgv check does not work.</p>
	</ol>
	<li><p align="left">To enable Raspbian cross-builds we must install
	the Raspbian archive keys.</p>
	<ol type="a">
		<li><p align="left">wget
		http://archive.raspbian.org/raspbian/pool/main/r/raspbian-archive-keyring/raspbian-archive-keyring_20120528.2_all.deb</p>
		<li><p align="left">sudo dpkg -i
		raspbian-archive-keyring_20120528.2_all.deb</p>
	</ol>
	<li><p align="left">Create the distribution base tarball.</p>
	<ol type="a">
		<li><p align="left">sudo OS=raspbian DIST=stretch ARCH=armhf
		pbuilder create --override-config</p>
	</ol>
	<li><p align="left">If adding a PPA or other repo, configure the
	chroot environment.</p>
	<ol type="a">
		<li><p align="left">If you added the extra packages above skip to
		4.d. If doing this for the first time for a distribution you will
		need the output of the following command.</p>
		<ul>
			<li><p align="left">dpkg-query -S $(which add-apt-repository)</p>
			<li><p align="left">Output will be like:-</p>
			<ul>
				<li><p align="left">software-properties-common:
				/usr/bin/add-apt-repository</p>
			</ul>
		</ul>
		<li><p align="left">Enter the pbuilder chroot.</p>
		<ul>
			<li><p align="left">sudo OS=raspbian DIST=stretch ARCH=armhf
			pbuilder login --save-after-login --override-config</p>
		</ul>
		<li><p align="left">If doing this for the first time for a
		distribution.</p>
		<ul>
			<li><p align="left">apt-get install software-properties-common</p>
			<li><p align="left">apt-get install wget</p>
			<li><p align="left">apt-get install gnupg2</p>
		</ul>
		<li><p align="left">Get the keys used for signing my dsc files:-</p>
		<ul>
			<li><p align="left">gpg --verbose --no-default-keyring --keyring
			trustedkeys.kbx --recv-keys 20ECF9F0</p>
			<li><p align="left">find /root/.gnupg -type s | xargs rm -fv</p>
		</ul>
		<li><p align="left">Add any required PPA repositories.</p>
		<ul>
			<li><p align="left">add-apt-repository ppa:m-grant-prg/utils</p>
		</ul>
		<li><p align="left">Add any local repositories and get their keys.</p>
		<ul>
			<li><p align="left">add-apt-repository 'deb
			http://hermes/aptrepos/raspbian stretch stable'</p>
			<li><p align="left">wget -O -
			<a href="http://hermes/aptrepos/raspbian/conf/hermes.gpg">http://hermes/aptrepos/raspbian/conf/hermes.gpg</a>
			| apt-key add -</p>
		</ul>
		<li><p align="left">Add Bintray if required.</p>
	</ol>
</ol>
<ol>
	<ol type="a">
		<ul>
			<li><p align="left">add-apt-repository 'deb
			https://dl.bintray.com/mgrantprg/utils stretch stableâ€™</p>
		</ul>
	</ol>
</ol>
<ol>
	<ol type="a">
		<ul>
			<li><p align="left">wget -O -
			https://bintray.com/user/downloadSubjectPublicKey?username=mgrantprg
			| apt-key add -</p>
		</ul>
		<li><p align="left">Add OpenSUSE Build Service if required.</p>
	</ol>
</ol>
<ol>
	<ol type="a">
		<ul>
			<li><p align="left">Do not perform this step if you have added the
			repo vi the pbuilderrc OTHERMIRROR variable, go to the wget.</p>
			<ul>
				<li><p align="left">echo 'deb
				http://download.opensuse.org/repositories/home:/m-grant-prg/Raspbian_9.0/
				/' &gt; /etc/apt/sources.list.d/home:m-grant-prg.list</p>
			</ul>
			<li><p align="left">wget -nv
			https://download.opensuse.org/repositories/home:m-grant-prg/Raspbian_9.0/Release.key
			-O Release.key</p>
			<li><p align="left">apt-key add - &lt; Release.key</p>
			<li><p align="left">rm Release.key</p>
		</ul>
	</ol>
</ol>
<ol>
	<ol type="a">
		<li><p align="left">Exit chroot environment.</p>
		<ul>
			<li><p align="left">Exit</p>
		</ul>
		<li><p align="left">Update the base package.</p>
		<ul>
			<li><p align="left">sudo OS=raspbian DIST=stretch ARCH=armhf
			pbuilder update --override-config</p>
		</ul>
	</ol>
</ol>
</body>
</html>